<!doctype html><html lang=en><head><title>Cargo Cult Code Generation :: Julian Dax</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Javascript Errors in the Wild Recently, I came across this code in the popular Axios library:
function AxiosError(message, code, config, request, response) { Error.call(this); // some more code i&amp;#39;ve left out for brevity } What does Error.call(this) do, you might ask? Nothing! I&amp;rsquo;ve tried it out in Node versions back until 6, Spidermonkey and JavaScriptCore. None of them do anything to the this object of the Error constructor. Moreover, the specification says that you have to be able to call the Error constructor without new, so it makes sense to implement it that way."><meta name=keywords content=","><meta name=robots content="noodp"><link rel=canonical href=https://juliand.ax/posts/cargo-cult-code-gen/><link rel=stylesheet href=https://juliand.ax/styles.css><link rel="shortcut icon" href=https://juliand.ax/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://juliand.ax/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta name=twitter:site content="jdax"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Cargo Cult Code Generation"><meta property="og:description" content="Javascript Errors in the Wild Recently, I came across this code in the popular Axios library:
function AxiosError(message, code, config, request, response) { Error.call(this); // some more code i&amp;#39;ve left out for brevity } What does Error.call(this) do, you might ask? Nothing! I&amp;rsquo;ve tried it out in Node versions back until 6, Spidermonkey and JavaScriptCore. None of them do anything to the this object of the Error constructor. Moreover, the specification says that you have to be able to call the Error constructor without new, so it makes sense to implement it that way."><meta property="og:url" content="https://juliand.ax/posts/cargo-cult-code-gen/"><meta property="og:site_name" content="Julian Dax"><meta property="og:image" content="https://juliand.ax/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2023-05-05 21:19:33 +0200 +0200"><a rel=me href=https://chaos.social/@brodo></a></head><body><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Julian Dax</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;â–¾</li><li><ul class=menu__dropdown><li><a href=/profile>Profile</a></li><li><a href=/showcase>Showcase</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/profile>Profile</a></li><li><a href=/showcase>Showcase</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://juliand.ax/posts/cargo-cult-code-gen/>Cargo Cult Code Generation</a></h1><div class=post-meta><time class=post-date>2023-05-05 ::</time></div><span class=post-tags>#<a href=https://juliand.ax/tags/javascript/>JavaScript</a>&nbsp;
#<a href=https://juliand.ax/tags/chatgpt/>ChatGPT</a>&nbsp;
#<a href=https://juliand.ax/tags/copilot/>Copilot</a>&nbsp;
#<a href=https://juliand.ax/tags/errors/>Errors</a>&nbsp;</span><div class=post-content><div><h2 id=javascript-errors-in-the-wild>Javascript Errors in the Wild<a href=#javascript-errors-in-the-wild class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Recently, I came across this code in the popular <a href=https://github.com/axios/axios/blob/21a5ad34c4a5956d81d338059ac0dd34a19ed094/lib/core/AxiosError.js>Axios library</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>AxiosError</span>(<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>code</span>, <span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>request</span>, <span style=color:#a6e22e>response</span>) {
</span></span><span style=display:flex><span>    Error.<span style=color:#a6e22e>call</span>(<span style=color:#66d9ef>this</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// some more code i&#39;ve left out for brevity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>What does <code>Error.call(this)</code> do, you might ask? Nothing! I&rsquo;ve tried it out in
Node versions back until 6, Spidermonkey and JavaScriptCore. None of them do anything to the <code>this</code> object of the
<code>Error</code> constructor. Moreover, <a href=https://262.ecma-international.org/13.0/#sec-error-constructor>the specification</a>
says that you have to be able to call the <code>Error</code> constructor without <code>new</code>, so it makes sense to implement it
that way. Depending on how good you know Javascript Errors, you might assume that this call might:</p><ol><li>Turn <code>this</code> into an <code>instanceof Error</code> - It does not.</li><li>Turn <code>this</code> into a <a href=https://nodejs.org/dist/latest-v20.x/docs/api/util.html#utiltypesisnativeerrorvalue>native error</a> - It does not.</li><li>Add a <code>stack</code> property to <code>this</code> - It does not.</li></ol><p><code>Error.call(this)</code> does absolutely nothing to <code>this</code>. Zero, zilch, nada. The only thing it does is <strong>waste a lot of CPU time</strong>.
It creates a new <code>Error</code> object and a new stack trace - a costly thing to do - and then lets the GC throw it away.</p><p>This is a a case of <strong><a href=https://en.wikipedia.org/wiki/Cargo_cult_programming>cargo cult programming</a></strong>:</p><blockquote><p>Cargo cult programming is a style of computer programming characterized by the ritual inclusion of code or program structures that serve no real purpose.</p></blockquote><p>I don&rsquo;t want to hate on Axios through, a ton of popular libraries do this! I&rsquo;ve <code>grep</code>ed through my <code>node_modules</code> folder and
found it in <a href=https://github.com/ReactiveX/rxjs/blob/6e3e5e49cb735289a8e8796dc58e682468a36028/src/internal/util/createErrorClass.ts>rxjs</a>
and <a href=https://github.com/auth0/node-jsonwebtoken/blob/a99fd4b473e257c2f50ff69c716db1c520bf9a78/lib/JsonWebTokenError.js>jsonwebtoken</a>.</p><p><a href="https://sourcegraph.com/search?q=context:global+%28language:JavaScript+OR+language:TypeScript%29+content:%22Error.call%28this%29%22+count:1000000&patternType=standard&sm=0&groupBy=repo">Sourcegraph finds more than 133K results in over 10k repos</a>
for both Typescript and Javascript if you search for <code>Error.call(this)</code>.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><h2 id=cargo-cult-copilot>Cargo Cult Copilot<a href=#cargo-cult-copilot class=hanchor arialabel=Anchor>&#8983;</a></h2><p>If Github Copilot is trained on this, will it generate code with <code>Error.call(this)</code> in it? I&rsquo;ve tried it by typing
<code>function CachingError</code> and let it generate from there:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Javascript data-lang=Javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>CachingError</span>(<span style=color:#a6e22e>message</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;CachingError&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>message</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stack</span> <span style=color:#f92672>=</span> (<span style=color:#66d9ef>new</span> Error()).<span style=color:#a6e22e>stack</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This can be done better, but no <code>Error.call(this)</code>. On my second try I got the following result:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Javascript data-lang=Javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>CachingError</span>() {
</span></span><span style=display:flex><span>    Error.<span style=color:#a6e22e>apply</span>(<span style=color:#66d9ef>this</span>, <span style=color:#a6e22e>arguments</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>There we are! Using <code>.apply</code> instead of <code>.call</code> and passing on the <code>arguments</code> array would even be a good idea
if the <code>Error</code> constructor would do something to it&rsquo;s <code>this</code>.</p><h2 id=cargogpt4>CargoGPT4<a href=#cargogpt4 class=hanchor arialabel=Anchor>&#8983;</a></h2><p>What about ChatGPT? I&rsquo;ve tried this prompt with GPT4:</p><style>.chat-inner>*{margin-block-start:0}</style><div style=display:flex;gap:1rem><div>Julian:</div><div style=flex-grow:1 class=chat-inner>Write me an Error subclass called <code>CachingError</code> in Javascript using prototypal inheritance.</div></div><br></br><style>.chat-inner>*{margin-block-start:0}</style><div style=display:flex;gap:1rem><div>ChatGPT:</div><div style=flex-grow:1 class=chat-inner><p>Here&rsquo;s an example of a CachingError subclass in JavaScript using prototypal inheritance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JavaScript data-lang=JavaScript><span style=display:flex><span><span style=color:#75715e>// Define the CachingError constructor
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>CachingError</span>(<span style=color:#a6e22e>message</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Call the Error constructor with the given message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Error.<span style=color:#a6e22e>call</span>(<span style=color:#66d9ef>this</span>, <span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Set the error name to &#39;CachingError&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;CachingError&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Capture the current stack trace and store it in the error object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Error.<span style=color:#a6e22e>captureStackTrace</span>(<span style=color:#66d9ef>this</span>, <span style=color:#a6e22e>CachingError</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Set up the prototype chain between CachingError and Error
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>CachingError</span>.<span style=color:#a6e22e>prototype</span> <span style=color:#f92672>=</span> Object.<span style=color:#a6e22e>create</span>(Error.<span style=color:#a6e22e>prototype</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>CachingError</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>constructor</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>CachingError</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Example usage
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CachingError</span>(<span style=color:#e6db74>&#39;An error occurred while caching data&#39;</span>);
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>name</span>); <span style=color:#75715e>// CachingError
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span>); <span style=color:#75715e>// An error occurred while caching data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>stack</span>); <span style=color:#75715e>// Stack trace
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div></div></div><br></br><p>On the first try!</p><h2 id=loras-to-the-rescue>LoRas to the Rescue!<a href=#loras-to-the-rescue class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The central problem with AI code generation is <a href=https://en.wikipedia.org/wiki/Sturgeon%27s_law>Sturgeon&rsquo;s law</a>:</p><blockquote><p>Sturgeon&rsquo;s law (or Sturgeon&rsquo;s revelation) is an adage stating &ldquo;ninety percent of everything is crap&rdquo;.</p></blockquote><p>90% of code is crap. That means instead of having gigantic models trained on everything that people
can get their hands on, use smaller models and train with better code. In the Stable Diffusion community, people train
<a href=https://arxiv.org/abs/2208.01618>textual inversions</a> with 5 images and <a href=https://arxiv.org/abs/2106.09685>LoRas</a> with ~20.
There needs to be a &ldquo;Javascript Error LoRa&rdquo; in ChatGPT and Copilot that fixes this.</p><h2 id=how-to-do-it-properly>How to Do It Properly<a href=#how-to-do-it-properly class=hanchor arialabel=Anchor>&#8983;</a></h2><p>If you want to create a subclass of <code>Error</code> use <code>class</code> syntax:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JavaScript data-lang=JavaScript><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyError</span> <span style=color:#66d9ef>extends</span> Error {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>constructor</span>(){
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>(...<span style=color:#a6e22e>arguments</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;MyError&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This way, your error will be a <a href=https://nodejs.org/dist/latest-v20.x/docs/api/util.html#utiltypesisnativeerrorvalue>native error</a>, <code>instanceof Error</code> and have a <code>.name</code> property that differentiates it from other errors.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>I&rsquo;m sure there are a lot for false positives and false negatives (<code>Error.apply</code>&mldr;) in this search, but you get the idea.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: <a href=https://github.com/panr/hugo-theme-terminal target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>